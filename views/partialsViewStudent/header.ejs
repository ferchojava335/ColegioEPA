<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Escuela Popular de Artes</title>
    <link rel="stylesheet" href="stylesheets/styleTemplate.css" type="text/css">
    <script src="//code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="/../javascripts/lib/handlebars-v1.3.0.js"></script>
    <script src="/../javascripts/lib/ember/ember.js"></script>
    <script src="/../javascripts/lib/ember-data/ember-data.js"></script>
    <script src="/../javascripts/lib/emberCalendar/ember-calendar.js"></script>
    <script src="/../javascripts/lib/jquery/ui/jquery-ui.min.js"></script>
    <script src="http://momentjs.com/downloads/moment.min.js"></script>
    <script src="http://dbushell.github.io/Pikaday/pikaday.js"></script>
    <script src="http://dbushell.github.io/Pikaday/pikaday.js"></script>
    <script src="/../javascripts/lib/bootstrap.js"></script>
    <script src="/../javascripts/lib/jqBootstrapValidation.js"></script>
</head>
<body>
    <script src="/../javascripts/Application.js"></script>
    <!--  start load all controllers-->
    <script src="/../javascripts/controllers/AttendanceController.js"></script>
    <script src="/../javascripts/controllers/CourseController.js"></script>
    <script src="/../javascripts/controllers/EnrollmentController.js"></script>
    <script src="/../javascripts/controllers/LoginController.js"></script>
    <script src="/../javascripts/controllers/RegisterStudentController.js"></script>
    <script src="/../javascripts/controllers/StudentController.js"></script>
    <script src="/../javascripts/controllers/SubjectMatterController.js"></script>
    <script src="/../javascripts/controllers/TeacherController.js"></script>
    <script src="/../javascripts/controllers/UserController.js"></script>

    <!--  end load all controllers-->

    <!--  start load all stores-->
    <script src="/../javascripts/stores/AttendanceAdapter.js"></script>
    <script src="/../javascripts/stores/CourseAdapter.js"></script>
    <script src="/../javascripts/stores/EnrollmentAdapter.js"></script>
    <script src="/../javascripts/stores/StudentAdapter.js"></script>
    <script src="/../javascripts/stores/SubjectMatterAdapter.js"></script>
    <script src="/../javascripts/stores/TeacherAdapter.js"></script>
    <script src="/../javascripts/stores/UserAdapter.js"></script>
    <!--  end load all stores-->

    <!--  start load all models-->
    <script src="/../javascripts/models/Attendance.js"></script>
    <script src="/../javascripts/models/Course.js"></script>
    <script src="/../javascripts/models/Enrollment.js"></script>
    <script src="/../javascripts/models/Student.js"></script>
    <script src="/../javascripts/models/SubjectMatter.js"></script>
    <script src="/../javascripts/models/Teacher.js"></script>
    <script src="/../javascripts/models/User.js"></script>
    <!--  end load all models-->

    <!-- start route-->
    <script src="/../javascripts/routes/AuthenticatedRoute.js"></script>
    <script src="/../javascripts/Utils/utilsEPA.js"></script>
    <!-- end route-->

    <script src="/../javascripts/helpers/DatePicker.js"></script>
    <script src="/../javascripts/helpers/ModalCourse.js"></script>




    <link rel="stylesheet" href="/../stylesheets/bootstrap.css" type="text/css">
    <link rel="stylesheet" href="/../stylesheets/bootstrap-responsive.css" type="text/css">
    <link rel="stylesheet" href="/../stylesheets/normalize.css" type="text/css">
    <link rel="stylesheet" href="/../stylesheets/style.css" type="text/css">
    <link rel="stylesheet" href="http://dbushell.github.io/Pikaday/css/pikaday.css">
    <link rel='stylesheet' href='/../stylesheets/menuStyles.css'>
    <link rel="stylesheet" href="/../stylesheets/styleTemplate.css" type="text/css">
    <link rel="stylesheet" href="/../javascripts/lib/emberCalendar/ember-calendar.css" type="text/css">
    <link rel='stylesheet' href='/../javascripts/lib/emberCalendar/ember-calendar.css'>
    <link rel='stylesheet' href='/../stylesheets/calendarStyle.css'>
    <link rel='stylesheet' href='/../stylesheets/jquery/jquery-ui.min.css'>

<script type="text/javascript">

$(document).ready(function() {
    $('ul li:has(ul)').hover(function(e) {
         $(this).find('ul').css({display: "block"});
     },
     function(e) {
         $(this).find('ul').css({display: "none"});
     });
    $('#session').text(utilsEPA.getLogin());
    //$('#dialog-form').hide();
    //debugger;
    $('#logout').on('click', function() {
        utilsEPA.logout();
    });

    //fill form to edit user

    $('#editUser').click(function() {
        $( "#dialog-form" ).dialog( {
            open:function() {
                utilsEPA.fillUser();
                $("input,select,textarea").not("[type=submit]").jqBootstrapValidation({submitSuccess: function($form, event) {
                    var formValues = $form.serializeArray();
                    var user = { user: {login:formValues[0].value, password:$('#password').val(),
                                        toke:'aa',
                                        email:formValues[3].value,
                                        role:utilsEPA.getRole(),
                                        objectOwner:utilsEPA.getObjectOwner()
                                    }
                                };
                    utilsEPA.updateSession(user.user);
                    var dataInfo = { name : $('#name').val(), email : $('#email').val(), ci : $('#ci').val(), birthDate : $('#birthDate').val()};
                    $.ajax({url:'http://localhost:3000/user/users/'+utilsEPA.getId(), type:"PUT", dataType: 'json',contentType: "application/x-www-form-urlencoded; charset=UTF-8",crossDomain: true, data:user,
                                success:function(result) {
                                    $.ajax({url: utilsEPA.getUrlByUser() , type:"PUT", dataType:'json', contentType:"application/x-www-form-urlencoded; charset=UTF-8",
                                        crossDomain:true, data : utilsEPA.builtUserInfo(dataInfo), headers : {'API_KEY': localStorage.getItem("token")},
                                        success: function(result) {
                                            window.href = "http://localhost:3000/student/attendance"
                                        }, error: function(result) {
                                        }
                                    });
                                }, error:function(res) {
                                    alert("Bad thing happend! " + res.statusText);
                                }
                    });
                },
                    submitError: function($form,event, errors) {
                        debugger;
                        console.log('error trying to send');
                    }
                });

                $('#birthDate').datepicker();
            }
        });
    });
    $('#cancel').click(function() {
        $('#dialog-form').dialog("close");
    });
});



function validateLogin($el, value, callback) {
    var callbackfunction = callback, regxUser=/^[a-zA-Z](([\._\-][a-zA-Z0-9])|[a-zA-Z0-9])*[a-z0-9]$/;

    if (utilsEPA.getLogin() === value) {
        callback({value:value, valid:true, message: 'formato incorrecto del nombre del Usuario'});
    }
    else if(regxUser.test(value)) {
        $.ajax({url:'http://localhost:3000/utils/userName/'+value, type:'GET', dataType: 'json',contentType: "application/json; charset=utf-8",
            success:function(result) {
                callbackfunction(result);
            },
            error:function(res) {
                callbackfunction({
                    value: value,
                    valid: false,
                    message: "error en el servidor contactar con el administrator"
                });
            }
        });
    } else {
        callback({value:value, valid:false, message: 'formato incorrecto del nombre del Usuario'});
    }
}

function validateCI($el, value, callback) {
    var callbackfunction = callback, ci = parseInt(value), regxCi = /[a-z]/i;
    if ( !regxCi.test(value) && !isNaN(ci) && ci >450000 && ci <12000000) {
        $.ajax({url:'http://localhost:3000/utils/ci/'+ci, type:'GET', dataType: 'json',contentType: "application/json; charset=utf-8",
            success:function(result) {
                result.value = value;
                callbackfunction(result);
            },
            error:function(res) {
                callbackfunction({
                    value: value,
                    valid: false,
                    message: "error en el servidor contactar con el administrator"
                });
            }
        });
    } else {
        callback({value:value, valid:false, message: 'ingreso un ci incorrecto'});
    }
}

</script>
<% include /menuOptions %>

<div id="dialog-form" title="Create new user" style="display:none" >
  <p class="validateTips">All form fields are required.</p>
  <form id="user-from" >

    <div class="control-group">
        <label for="login" class="control-label">Login</label>
        <div class="controls">
            <input type="text" name="ajax-login"  data-validation-callback-callback="validateLogin"  id="login"  />
        </div>
    </div>
    <div class="control-group">
        <label class="control-label" for="password">Password</label>
        <div class="controls">
            <input type="password" id="password" pattern="^.*(?=.{4,10})(?=.*\d)(?=.*[a-zA-Z]).*$" data-validation-pattern-message="formato de password incorrecto" />
        </div>
    </div>
    <div class="control-group">
        <label for="name" class="control-label">Name</label>
        <div class="controls">
            <input type="text" name="name" id="name" pattern="^[A-Za-z0-9 ]{3,20}$" data-validation-required-message="el nombre es requerido" />
        </div>
    </div>
    <!-- control for student ci -->

    <div class="control-group">
        <label for="ci" class="control-label">CI</label>
        <div class="controls">
            <input type="number" name="ci" id="ci" data-validation-callback-callback="validateCI"/>
        </div>
    </div>

    <!-- control for student email -->
    <div class="control-group">
        <label for="email"  class="control-label">Email</label>
        <div class="controls">
            <input type="email" name="email" id="email" data-validation-email-message="ingrese una direccion de correo electronico valida"/>
        </div>
    </div>
    <!-- control for student birth date -->
    <div class="control-group">
        <label for="birthDate" class="control-label">Fecha de Nacimiento </label>
        <div class="controls">
            <input type="tex" pattern="(0[1-9]|1[012])[- /.](0[1-9]|[12][0-9]|3[01])[- /.](19|20)\d\d" name="birthDate" id="birthDate" data-validation-pattern-message="fecha de nacimiento invalida"/>
        </div>
    </div>
      <input id="save" type="submit" value="GUARDAR" class="btn">
      <input id="cancel" type="button" value="CANCELAR"  class="btn" style="float:right">
  </form>
</div>
